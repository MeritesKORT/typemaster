{% extends 'typetester/base.html' %}

{% block title %}–¢–µ—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø–µ—á–∞—Ç–∏{% endblock %}

{% block extra_css %}
<style>
    .test-container {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        max-width: 800px;
        margin: 0 auto;
    }
    
    .stats-bar {
        display: flex;
        justify-content: space-between;
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        font-size: 1.1rem;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #4a6cf7;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #666;
    }
    
    .text-display {
        background: #f8f9fa;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        font-size: 1.2rem;
        line-height: 1.6;
        min-height: 150px;
        border: 2px solid #e9ecef;
    }
    
    .text-to-type {
        color: #666;
    }
    
    .typed-text {
        color: #333;
        font-weight: 500;
    }
    
    .current-char {
        background: #4a6cf7;
        color: white;
        padding: 0 2px;
        border-radius: 3px;
    }
    
    .error-char {
        background: #dc3545;
        color: white;
        padding: 0 2px;
        border-radius: 3px;
        text-decoration: line-through;
    }
    
    .text-input {
        width: 100%;
        padding: 1rem;
        font-size: 1.2rem;
        border: 2px solid #ddd;
        border-radius: 10px;
        margin-bottom: 1rem;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .text-input:focus {
        outline: none;
        border-color: #4a6cf7;
    }
    
    .controls {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }
    
    .btn-restart {
        background: #6c757d;
    }
    
    .results-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .results-content {
        background: white;
        padding: 3rem;
        border-radius: 15px;
        text-align: center;
        max-width: 500px;
        width: 90%;
    }
    
    .result-score {
        font-size: 4rem;
        font-weight: bold;
        color: #4a6cf7;
        margin: 1rem 0;
    }
    
    .result-details {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin: 2rem 0;
    }
    
    .result-item {
        text-align: center;
    }
    
    .result-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
    }
    
    .result-label {
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="test-container">
    <h1 style="text-align: center; margin-bottom: 2rem; color: #333;">
        –¢–µ—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø–µ—á–∞—Ç–∏
    </h1>
    
    <div class="stats-bar">
        <div class="stat-item">
            <div class="stat-value" id="timer">0.0</div>
            <div class="stat-label">–í—Ä–µ–º—è (—Å–µ–∫)</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="wpm">0</div>
            <div class="stat-label">WPM</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="accuracy">100%</div>
            <div class="stat-label">–¢–æ—á–Ω–æ—Å—Ç—å</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="errors">0</div>
            <div class="stat-label">–û—à–∏–±–∫–∏</div>
        </div>
    </div>
    
    <div class="text-display" id="textDisplay">
        <span id="textToType">{{ text }}</span>
    </div>
    
    <textarea 
        id="textInput" 
        class="text-input" 
        placeholder="–ù–∞—á–Ω–∏—Ç–µ –ø–µ—á–∞—Ç–∞—Ç—å –∑–¥–µ—Å—å..."
        rows="3"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
    ></textarea>
    
    <div class="controls">
        <button class="btn" onclick="startTest()" id="startBtn">
            <i class="fas fa-play"></i> –ù–∞—á–∞—Ç—å
        </button>
        <button class="btn btn-restart" onclick="restartTest()">
            <i class="fas fa-redo"></i> –ó–∞–Ω–æ–≤–æ
        </button>
        <a href="{% url 'home' %}" class="btn btn-secondary">
            <i class="fas fa-home"></i> –ù–∞ –≥–ª–∞–≤–Ω—É—é
        </a>
    </div>
    
    <div style="margin-top: 2rem; color: #666; font-size: 0.9rem;">
        <p><i class="fas fa-lightbulb"></i> –°–æ–≤–µ—Ç: –ù–µ —Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É, —Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å –ø–µ—á–∞—Ç–∞—Ç—å –≤—Å–ª–µ–ø—É—é</p>
        <p><i class="fas fa-lightbulb"></i> –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: {{ difficulty|title }} —É—Ä–æ–≤–µ–Ω—å, {{ language|upper }} —è–∑—ã–∫</p>
    </div>
</div>

<div class="results-modal" id="resultsModal">
    <div class="results-content">
        <h2>–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! üéâ</h2>
        <div class="result-score" id="finalWPM">0</div>
        <p style="color: #666; margin-bottom: 2rem;">—Å–ª–æ–≤ –≤ –º–∏–Ω—É—Ç—É</p>
        
        <div class="result-details">
            <div class="result-item">
                <div class="result-value" id="finalAccuracy">100%</div>
                <div class="result-label">–¢–æ—á–Ω–æ—Å—Ç—å</div>
            </div>
            <div class="result-item">
                <div class="result-value" id="finalTime">0.0</div>
                <div class="result-label">–í—Ä–µ–º—è</div>
            </div>
            <div class="result-item">
                <div class="result-value" id="finalErrors">0</div>
                <div class="result-label">–û—à–∏–±–∫–∏</div>
            </div>
        </div>
        
        <div style="margin-top: 2rem;">
            <button class="btn" onclick="restartTest()" style="margin-right: 1rem;">
                <i class="fas fa-redo"></i> –ï—â–µ —Ä–∞–∑
            </button>
            <a href="{% url 'leaderboard' %}" class="btn btn-secondary">
                <i class="fas fa-trophy"></i> –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤
            </a>
        </div>
    </div>
</div>

<input type="hidden" id="originalText" value="{{ text }}">
<input type="hidden" id="textId" value="{{ text_id|default:'' }}">
{% endblock %}

{% block extra_js %}
<script>
    let startTime = null;
    let timerInterval = null;
    let isTestRunning = false;
    let totalErrors = 0;
    let hasTypedChar = [];     // –í–≤–æ–¥–∏–ª—Å—è –ª–∏ —Å–∏–º–≤–æ–ª –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ i
    let hasError = [];         // –ë—ã–ª–∞ –ª–∏ –æ—à–∏–±–∫–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ i
    let originalText = '';
    let currentText = '';

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function () {
        const originalTextarea = document.getElementById('originalText');
        if (originalTextarea) {
            originalText = originalTextarea.value;
        }
        document.getElementById('textInput').focus();
        updateTextDisplay();
    });

    function startTest() {
        if (!isTestRunning) {
            startTime = new Date();
            isTestRunning = true;
            document.getElementById('textInput').focus();
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-pause"></i> –ü–∞—É–∑–∞';
            document.getElementById('startBtn').onclick = pauseTest;
            timerInterval = setInterval(updateTimer, 100);
        }
    }

    function pauseTest() {
        if (isTestRunning) {
            clearInterval(timerInterval);
            isTestRunning = false;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
            document.getElementById('startBtn').onclick = startTest;
        }
    }

    function restartTest() {
        clearInterval(timerInterval);
        isTestRunning = false;
        startTime = null;
        totalErrors = 0;
        hasTypedChar = [];
        hasError = [];
        currentText = '';

        document.getElementById('textInput').value = '';
        document.getElementById('timer').textContent = '0.0';
        document.getElementById('wpm').textContent = '0';
        if (document.getElementById('cps')) {
            document.getElementById('cps').textContent = '0.0';
        }
        document.getElementById('accuracy').textContent = '100%';
        document.getElementById('errors').textContent = '0';
        document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> –ù–∞—á–∞—Ç—å';
        document.getElementById('startBtn').onclick = startTest;
        document.getElementById('resultsModal').style.display = 'none';
        updateTextDisplay();
    }

    function updateTimer() {
        if (!startTime || !isTestRunning) return;

        const currentTime = new Date();
        const elapsed = (currentTime - startTime) / 1000;
        document.getElementById('timer').textContent = elapsed.toFixed(1);

        const charsTyped = currentText.length;

        // CPS ‚Äî —Å–∏–º–≤–æ–ª—ã –≤ —Å–µ–∫—É–Ω–¥—É
        const cps = elapsed > 0 ? charsTyped / elapsed : 0;
        if (document.getElementById('cps')) {
            document.getElementById('cps').textContent = cps.toFixed(1);
        }

        // WPM ‚Äî –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É: 1 —Å–ª–æ–≤–æ = 5 —Å–∏–º–≤–æ–ª–æ–≤
        const wpm = elapsed > 0 ? Math.round((charsTyped / 5 / elapsed) * 60) : 0;
        document.getElementById('wpm').textContent = wpm;

        // –¢–æ—á–Ω–æ—Å—Ç—å: % –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Å—Ä–µ–¥–∏ –≤–≤–µ–¥—ë–Ω–Ω—ã—Ö
        let correct = 0;
        for (let i = 0; i < charsTyped && i < originalText.length; i++) {
            if (hasTypedChar[i] && currentText[i] === originalText[i]) {
                correct++;
            }
        }
        const accuracy = charsTyped > 0 ? Math.round((correct / charsTyped) * 100) : 100;

        document.getElementById('accuracy').textContent = accuracy + '%';
        document.getElementById('errors').textContent = totalErrors;
    }

    function updateTextDisplay() {
        const display = document.getElementById('textToType');
        if (!display) return;

        let html = '';
        for (let i = 0; i < originalText.length; i++) {
            if (i < currentText.length) {
                if (hasTypedChar[i] && currentText[i] === originalText[i]) {
                    html += `<span class="typed-text">${originalText[i]}</span>`;
                } else {
                    html += `<span class="error-char">${originalText[i]}</span>`;
                }
            } else if (i === currentText.length) {
                html += `<span class="current-char">${originalText[i]}</span>`;
            } else {
                html += `<span class="text-to-type">${originalText[i]}</span>`;
            }
        }
        display.innerHTML = html;
    }

    function finishTest() {
        clearInterval(timerInterval);
        isTestRunning = false;

        const endTime = new Date();
        const elapsed = (endTime - startTime) / 1000;
        const charsTyped = currentText.length;

        const wpm = elapsed > 0 ? Math.round((charsTyped / 5 / elapsed) * 60) : 0;

        let correctChars = 0;
        for (let i = 0; i < originalText.length; i++) {
            if (hasTypedChar[i] && currentText[i] === originalText[i]) {
                correctChars++;
            }
        }
        const accuracy = Math.round((correctChars / originalText.length) * 100);

        document.getElementById('finalWPM').textContent = wpm;
        document.getElementById('finalAccuracy').textContent = accuracy + '%';
        document.getElementById('finalTime').textContent = elapsed.toFixed(1);
        document.getElementById('finalErrors').textContent = totalErrors;
        document.getElementById('resultsModal').style.display = 'flex';

        saveResult(wpm, accuracy, elapsed, totalErrors);
    }

    function saveResult(wpm, accuracy, time, errorCount) {
        const textIdElem = document.getElementById('textId');
        const textId = textIdElem ? textIdElem.value || null : null;

        fetch('{% url "save_result" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                typed_text: currentText,
                original_text: originalText,
                time_seconds: time,
                mistakes: errorCount,
                text_id: textId
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω:', data);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', error);
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById('textInput').addEventListener('input', function (e) {
        if (!isTestRunning && startTime === null) {
            startTest();
        }

        const newValue = e.target.value;
        const oldLength = currentText.length;
        const newLength = newValue.length;

        if (newLength < oldLength) {
            // –£–¥–∞–ª–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤
            currentText = newValue;
            hasTypedChar = hasTypedChar.slice(0, newLength);
            hasError = hasError.slice(0, newLength);
            updateTextDisplay();
            return;
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç)
        if (newLength > oldLength && newLength <= originalText.length) {
            const pos = newLength - 1;
            const newChar = newValue[pos];
            const expectedChar = originalText[pos];

            hasTypedChar[pos] = true;

            // –§–∏–∫—Å–∏—Ä—É–µ–º –æ—à–∏–±–∫—É —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
            if (newChar !== expectedChar && !hasError[pos]) {
                hasError[pos] = true;
                totalErrors++;
            }
        }

        currentText = newValue;
        updateTextDisplay();

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∞–±–æ—Ä–µ –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞
        if (currentText.length === originalText.length) {
            finishTest();
        }
    });

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ Tab
    document.getElementById('textInput').addEventListener('keydown', function (e) {
        if (e.key === 'Tab') {
            e.preventDefault();
        }
    });
</script>
{% endblock %}