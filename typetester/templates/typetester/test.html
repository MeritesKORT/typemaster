{% extends 'typetester/base.html' %}

{% block title %}–¢–µ—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø–µ—á–∞—Ç–∏{% endblock %}

{% block extra_css %}
<style>
    .test-container {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        max-width: 800px;
        margin: 0 auto;
    }
    
    .stats-bar {
        display: flex;
        justify-content: space-between;
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        font-size: 1.1rem;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #4a6cf7;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #666;
    }
    
    .text-display {
        background: #f8f9fa;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        font-size: 1.2rem;
        line-height: 1.6;
        min-height: 150px;
        border: 2px solid #e9ecef;
    }
    
    .text-to-type {
        color: #666;
    }
    
    .typed-text {
        color: #333;
        font-weight: 500;
    }
    
    .current-char {
        background: #4a6cf7;
        color: white;
        padding: 0 2px;
        border-radius: 3px;
    }
    
    .error-char {
        background: #dc3545;
        color: white;
        padding: 0 2px;
        border-radius: 3px;
        text-decoration: line-through;
    }
    
    .text-input {
        width: 100%;
        padding: 1rem;
        font-size: 1.2rem;
        border: 2px solid #ddd;
        border-radius: 10px;
        margin-bottom: 1rem;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .text-input:focus {
        outline: none;
        border-color: #4a6cf7;
    }
    
    .controls {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }
    
    .btn-restart {
        background: #6c757d;
    }
    
    .results-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .results-content {
        background: white;
        padding: 3rem;
        border-radius: 15px;
        text-align: center;
        max-width: 500px;
        width: 90%;
    }
    
    .result-score {
        font-size: 4rem;
        font-weight: bold;
        color: #4a6cf7;
        margin: 1rem 0;
    }
    
    .result-details {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin: 2rem 0;
    }
    
    .result-item {
        text-align: center;
    }
    
    .result-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
    }
    
    .result-label {
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="test-container">
    <h1 style="text-align: center; margin-bottom: 2rem; color: #333;">
        –¢–µ—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø–µ—á–∞—Ç–∏
    </h1>
    
    <div class="stats-bar">
        <div class="stat-item">
            <div class="stat-value" id="timer">0.0</div>
            <div class="stat-label">–í—Ä–µ–º—è (—Å–µ–∫)</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="wpm">0</div>
            <div class="stat-label">WPM</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="accuracy">100%</div>
            <div class="stat-label">–¢–æ—á–Ω–æ—Å—Ç—å</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="errors">0</div>
            <div class="stat-label">–û—à–∏–±–∫–∏</div>
        </div>
    </div>
    
    <div class="text-display" id="textDisplay">
        <span id="textToType">{{ text }}</span>
    </div>
    
    <textarea 
        id="textInput" 
        class="text-input" 
        placeholder="–ù–∞—á–Ω–∏—Ç–µ –ø–µ—á–∞—Ç–∞—Ç—å –∑–¥–µ—Å—å..."
        rows="3"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
    ></textarea>
    
    <div class="controls">
        <button class="btn" onclick="startTest()" id="startBtn">
            <i class="fas fa-play"></i> –ù–∞—á–∞—Ç—å
        </button>
        <button class="btn btn-restart" onclick="restartTest()">
            <i class="fas fa-redo"></i> –ó–∞–Ω–æ–≤–æ
        </button>
        <a href="{% url 'home' %}" class="btn btn-secondary">
            <i class="fas fa-home"></i> –ù–∞ –≥–ª–∞–≤–Ω—É—é
        </a>
    </div>
    
    <div style="margin-top: 2rem; color: #666; font-size: 0.9rem;">
        <p><i class="fas fa-lightbulb"></i> –°–æ–≤–µ—Ç: –ù–µ —Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É, —Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å –ø–µ—á–∞—Ç–∞—Ç—å –≤—Å–ª–µ–ø—É—é</p>
        <p><i class="fas fa-lightbulb"></i> –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: {{ difficulty|title }} —É—Ä–æ–≤–µ–Ω—å, {{ language|upper }} —è–∑—ã–∫</p>
    </div>
</div>

<div class="results-modal" id="resultsModal">
    <div class="results-content">
        <h2>–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! üéâ</h2>
        <div class="result-score" id="finalWPM">0</div>
        <p style="color: #666; margin-bottom: 2rem;">—Å–ª–æ–≤ –≤ –º–∏–Ω—É—Ç—É</p>
        
        <div class="result-details">
            <div class="result-item">
                <div class="result-value" id="finalAccuracy">100%</div>
                <div class="result-label">–¢–æ—á–Ω–æ—Å—Ç—å</div>
            </div>
            <div class="result-item">
                <div class="result-value" id="finalTime">0.0</div>
                <div class="result-label">–í—Ä–µ–º—è</div>
            </div>
            <div class="result-item">
                <div class="result-value" id="finalErrors">0</div>
                <div class="result-label">–û—à–∏–±–∫–∏</div>
            </div>
        </div>
        
        <div style="margin-top: 2rem;">
            <button class="btn" onclick="restartTest()" style="margin-right: 1rem;">
                <i class="fas fa-redo"></i> –ï—â–µ —Ä–∞–∑
            </button>
            <a href="{% url 'leaderboard' %}" class="btn btn-secondary">
                <i class="fas fa-trophy"></i> –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤
            </a>
        </div>
    </div>
</div>

<input type="hidden" id="originalText" value="{{ text }}">
<input type="hidden" id="textId" value="{{ text_id|default:'' }}">
{% endblock %}

{% block extra_js %}
<script>
    let startTime = null;
    let timerInterval = null;
    let isTestRunning = false;
    let totalErrors = 0; // –§–∏–∫—Å–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ù–ê–í–°–ï–ì–î–ê
    let hasTypedChar = []; // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º, –±—ã–ª –ª–∏ –≤–≤–µ–¥—ë–Ω –∫–∞–∂–¥—ã–π —Å–∏–º–≤–æ–ª
    let originalText = document.getElementById('originalText').value;
    let currentText = '';

    function startTest() {
        if (!isTestRunning) {
            startTime = new Date();
            isTestRunning = true;
            document.getElementById('textInput').focus();
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-pause"></i> –ü–∞—É–∑–∞';
            document.getElementById('startBtn').onclick = pauseTest;
            timerInterval = setInterval(updateTimer, 100);
        }
    }

    function pauseTest() {
        if (isTestRunning) {
            clearInterval(timerInterval);
            isTestRunning = false;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
            document.getElementById('startBtn').onclick = startTest;
        }
    }

    function restartTest() {
        clearInterval(timerInterval);
        isTestRunning = false;
        startTime = null;
        totalErrors = 0;
        hasTypedChar = [];
        currentText = '';

        document.getElementById('textInput').value = '';
        document.getElementById('timer').textContent = '0.0';
        document.getElementById('wpm').textContent = '0';
        document.getElementById('accuracy').textContent = '100%';
        document.getElementById('errors').textContent = '0';
        document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> –ù–∞—á–∞—Ç—å';
        document.getElementById('startBtn').onclick = startTest;
        document.getElementById('resultsModal').style.display = 'none';
        updateTextDisplay();
    }

    function updateTimer() {
        if (startTime && isTestRunning) {
            let currentTime = new Date();
            let elapsed = (currentTime - startTime) / 1000;
            document.getElementById('timer').textContent = elapsed.toFixed(1);

            let words = currentText.trim() === '' ? 0 : currentText.trim().split(/\s+/).length;
            let wpm = words > 0 ? Math.round((words / elapsed) * 60) : 0;
            document.getElementById('wpm').textContent = wpm;

            let accuracy = 100;
            if (currentText.length > 0) {
                let correct = 0;
                for (let i = 0; i < Math.min(currentText.length, originalText.length); i++) {
                    if (hasTypedChar[i] && currentText[i] === originalText[i]) {
                        correct++;
                    }
                }
                // –ù–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç
                accuracy = Math.max(0, (currentText.length - totalErrors) / originalText.length * 100);
            }
            document.getElementById('accuracy').textContent = Math.round(accuracy) + '%';
            document.getElementById('errors').textContent = totalErrors;
        }
    }

    function updateTextDisplay() {
        let display = document.getElementById('textToType');
        let html = '';

        for (let i = 0; i < originalText.length; i++) {
            if (i < currentText.length) {
                if (hasTypedChar[i] && currentText[i] === originalText[i]) {
                    html += `<span class="typed-text">${originalText[i]}</span>`;
                } else {
                    html += `<span class="error-char">${originalText[i]}</span>`;
                }
            } else if (i === currentText.length) {
                html += `<span class="current-char">${originalText[i]}</span>`;
            } else {
                html += `<span class="text-to-type">${originalText[i]}</span>`;
            }
        }
        display.innerHTML = html;
    }

    function finishTest() {
        clearInterval(timerInterval);
        isTestRunning = false;

        let endTime = new Date();
        let elapsed = (endTime - startTime) / 1000;
        let words = currentText.trim() === '' ? 0 : currentText.trim().split(/\s+/).length;
        let wpm = words > 0 ? Math.round((words / elapsed) * 60) : 0;

        let correctChars = 0;
        for (let i = 0; i < originalText.length; i++) {
            if (hasTypedChar[i] && currentText[i] === originalText[i]) {
                correctChars++;
            }
        }
        let accuracy = Math.round((correctChars / originalText.length) * 100);

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º totalErrors –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞
        document.getElementById('finalWPM').textContent = wpm;
        document.getElementById('finalAccuracy').textContent = accuracy + '%';
        document.getElementById('finalTime').textContent = elapsed.toFixed(1);
        document.getElementById('finalErrors').textContent = totalErrors;
        document.getElementById('resultsModal').style.display = 'flex';

        saveResult(wpm, accuracy, elapsed, totalErrors);
    }

    function saveResult(wpm, accuracy, time, errorCount) {
        fetch('{% url "save_result" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                typed_text: currentText,
                original_text: originalText,
                time_seconds: time,
                mistakes: errorCount,
                text_id: document.getElementById('textId').value || null
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Result saved:', data);
        })
        .catch(error => {
            console.error('Error saving result:', error);
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∫–∞–∂–¥—ã–π –≤–≤–µ–¥—ë–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª
    document.getElementById('textInput').addEventListener('input', function(e) {
        if (!isTestRunning && startTime === null) {
            startTest();
        }

        const newValue = e.target.value;
        const oldLength = currentText.length;
        const newLength = newValue.length;

        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—è–µ—Ç —Å–∏–º–≤–æ–ª
        if (newLength < oldLength) {
            // –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç totalErrors ‚Äî –æ—à–∏–±–∫–∞ —É–∂–µ –±—ã–ª–∞!
            // –ù–æ –º—ã –æ—á–∏—â–∞–µ–º hasTypedChar –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π
            currentText = newValue;
            hasTypedChar = hasTypedChar.slice(0, newLength);
            updateTextDisplay();
            return;
        }

        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–∏–º–≤–æ–ª
        if (newLength > oldLength && newLength <= originalText.length) {
            const newChar = newValue[newLength - 1];
            const expectedChar = originalText[newLength - 1];

            // –§–∏–∫—Å–∏—Ä—É–µ–º, —á—Ç–æ —ç—Ç–æ—Ç —Å–∏–º–≤–æ–ª –±—ã–ª –≤–≤–µ–¥—ë–Ω
            hasTypedChar[newLength - 1] = true;

            // –ï—Å–ª–∏ —Å–∏–º–≤–æ–ª –Ω–µ–≤–µ—Ä–Ω—ã–π ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ù–ê–í–°–ï–ì–î–ê
            if (newChar !== expectedChar) {
                totalErrors++;
            }
        }

        currentText = newValue;
        updateTextDisplay();

        // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç–µ—Å—Ç, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –Ω–∞–±—Ä–∞–Ω–æ –°–¢–û–õ–¨–ö–û –ñ–ï —Å–∏–º–≤–æ–ª–æ–≤, —Å–∫–æ–ª—å–∫–æ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ
        if (currentText.length === originalText.length) {
            finishTest();
        }
    });

    document.getElementById('textInput').addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
            e.preventDefault();
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('textInput').focus();
        updateTextDisplay();
    });
</script>
{% endblock %}